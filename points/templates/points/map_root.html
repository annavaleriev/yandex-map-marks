<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Карта: все точки</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ключ берётся из контекст-процессора -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey={{ YMAPS_API_KEY }}&lang=ru_RU"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    ymaps.ready(async () => {
      const map = new ymaps.Map('map', { center: [55.751244, 37.618423], zoom: 4 });

      {#const res = await fetch('/api/shares/2063894f9de7409f9791c911a99a9cfb/');#}
      {#const points = await res.json();#}

      const collection = new ymaps.GeoObjectCollection();
      {#for (const p of points.points) {#}
      {#  const lat = parseFloat(p.latitude);#}
      {#  const lon = parseFloat(p.longitude);#}
      {#  if (Number.isFinite(lat) && Number.isFinite(lon)) {#}
      {#    const pm = new ymaps.Placemark([lat, lon], {#}
      {#      balloonContent: `<b>${p.title || ''}</b><br>${lat}, ${lon}`#}
      {#    });#}
      {#    collection.add(pm);#}
      {#  }}#}
      {#map.geoObjects.add(collection);#}
      {#if (collection.getBounds()) {#}
      {#  map.setBounds(collection.getBounds(), { checkZoomRange: true, zoomMargin: 20 });}#}
    });
  </script>
</body>
</html>
