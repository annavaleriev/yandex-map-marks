<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Карта — {{ slug }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
    .status {
      position: absolute; z-index: 10; top: 12px; left: 12px;
      background: rgba(255,255,255,.92); padding: 8px 10px; border-radius: 8px;
      font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
    }
    .error { color: #b00020; }
  </style>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey={{ YMAPS_API_KEY }}"></script>
</head>
<body>
  <div class="status" id="status">Загружаю точки…</div>
  <div id="map"></div>

  <script>
    const STATUS = document.getElementById('status');
    const SLUG = "{{ slug }}";

    function jsonToGeoJSON(points) {
      return {
        type: "FeatureCollection",
        features: points.map(p => ({
          type: "Feature",
          id: p.id,
          geometry: { type: "Point", coordinates: [p.longitude, p.latitude] },
          properties: {
            balloonContentHeader: p.title || `Точка #${p.id}`,
            hintContent: p.title || `Точка #${p.id}`
          }
        }))
      };
    }

    async function loadPoints() {
      const res = await fetch(`/api/shares/${SLUG}/`, {cache: 'no-store'});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    ymaps.ready(async () => {
      const map = new ymaps.Map('map', {
        center: [37.618423, 55.751244],
        zoom: 5,
        controls: ['zoomControl', 'geolocationControl', 'typeSelector']
      });

      const objectManager = new ymaps.ObjectManager({
        clusterize: true,
        gridSize: 64,
        clusterDisableClickZoom: false
      });
      objectManager.objects.options.set('preset', 'islands#redIcon');
      objectManager.clusters.options.set('preset', 'islands#redClusterIcons');
      map.geoObjects.add(objectManager);

      try {
        const points = await loadPoints();
        const geojson = jsonToGeoJSON(points.points);
        objectManager.add(geojson);

        if (geojson.features.length > 0) {
          const coords = geojson.features.map(f => f.geometry.coordinates);
          const bounds = ymaps.geoQuery(coords.map(c => new ymaps.geometry.Point(c))).getBounds();
          if (bounds) map.setBounds(bounds, {checkZoomRange: true, zoomMargin: 50});
        }

        STATUS.textContent = `Готово: ${objectManager.objects.getLength()} точек`;
        setTimeout(() => STATUS.remove(), 1500);
      } catch (e) {
        console.error(e);
        STATUS.classList.add('error');
        STATUS.textContent = 'Ошибка загрузки точек';
      }
    });
  </script>
</body>
</html>
