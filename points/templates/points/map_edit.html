<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey={{ YMAPS_API_KEY }}"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
    .panel {
      position: absolute; z-index: 10; top: 12px; left: 12px;
      background: rgba(255,255,255,.95); padding: 10px 12px; border-radius: 10px;
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      box-shadow: 0 2px 10px rgba(0,0,0,.1);
      min-width: 280px;
    }

    /* --- РОВНАЯ СТРОКА С LABEL + INPUT --- */
    .row { margin-bottom: 8px; }
    .row:first-child {
      display: flex;
      align-items: center;       /* вертикальное выравнивание */
      gap: 8px;                  /* отступ между label и input */
    }
    .row:first-child label {
      font-size: 12px; color: #555; margin: 0;
      white-space: nowrap;       /* не переносить подпись */
      flex: 0 0 auto;            /* фиксированная ширина по контенту */
    }
    .row:first-child input {
      flex: 1;                   /* занимает всё оставшееся место */
      width: auto;               /* ширина контролируется flex */
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;    /* чтобы padding/граница входили в ширину */
      font: inherit;
    }
    /* --- остальное как было --- */
    .btn { display: inline-block; padding: 7px 10px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; background: #fafafa; }
    .btn.primary { background: #2e7d32; color: white; border-color: #2e7d32; }
    .btn.warn { background: #b00020; color: #fff; border-color: #b00020; }
    .muted { color: #666; font-size: 12px; }
    .error { color: #b00020; }
    .list { max-height: 160px; overflow: auto; margin-top: 6px; }
    .list li { font-size: 12px; margin-bottom: 4px; }
    .pill { display:inline-block; padding:2px 6px; border-radius: 10px; background:#eee; margin-left:6px; font-size:12px; }
  </style>
</head>
<body>
  <div class="panel">
    <div class="row">
      <label for="title">Подпись для точки</label>
      <input id="title" placeholder="Например: Офис, Склад..." />
    </div>
    <div id="shareLink" class="row" style="margin-top:6px;"></div>
    <div class="row muted">
      Кликните по карте — точка добавится в <em>черновик</em>
      Сохраните их одним запросом.
    </div>

    <div class="row">
      <button class="btn primary" id="saveBatch" disabled>Сохранить 0 точек</button>
      <button class="btn" id="undoLast" disabled>Отменить последнюю</button>
      <button class="btn warn" id="clearDraft" disabled>Очистить черновик</button>
    </div>

    <div class="row">
      <button class="btn" id="openView">Открыть карту</button>
    </div>

    <div class="row">
      <div class="muted">Добавлено в черновик: <span id="dbCount">—</span> <span id="draftCount" class="pill">0</span></div>
      <ul id="list" class="list"></ul>
    </div>
  </div>

  <div id="map"></div>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const CSRF = getCookie('csrftoken');
    async function addPointsBulk(pointsArr) {
      const body = { points: pointsArr };
      console.log(body);
      const r = await fetch(`/api/shares/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': CSRF || ''
        },
        body: JSON.stringify(body)
      });
      if (!r.ok) {
        const t = await r.text().catch(() => '');
        throw new Error('add points: ' + r.status + ' ' + t);
      }
      return r.json();
    }

    function renderDbList(points) {
      const ul = document.getElementById('list');
      ul.innerHTML = '';
      for (const p of points) {
        const li = document.createElement('li');
        li.textContent = `${p.title || '(без названия)'} — ${p.latitude}, ${p.longitude}`;
        ul.appendChild(li);
      }
      document.getElementById('dbCount').textContent = points.length;
    }

    ymaps.ready(async () => {
      const statusEl = document.getElementById('status');
      const titleInput = document.getElementById('title');
      const saveBtn = document.getElementById('saveBatch');
      const undoBtn = document.getElementById('undoLast');
      const clearBtn = document.getElementById('clearDraft');
      const draftCountEl = document.getElementById('draftCount');

      // база (с сервера) рисуем одной коллекцией
      const map = new ymaps.Map('map', { center: [55.751244, 37.618423], zoom: 5 });
      const dbCollection = new ymaps.GeoObjectCollection();
      map.geoObjects.add(dbCollection);

      // черновик (клики до отправки) — отдельная коллекция с другим пресетом
      const draftCollection = new ymaps.GeoObjectCollection({}, { preset: 'islands#blueDotIcon' });
      map.geoObjects.add(draftCollection);

      let draft = []; // [{latitude, longitude, title}]
      function updateDraftUI() {
        draftCountEl.textContent = `черновик: ${draft.length}`;
        saveBtn.textContent = `Сохранить ${draft.length} точек${draft.length % 10 === 1 && draft.length % 100 !== 11 ? 'у' : (draft.length % 10 >= 2 && draft.length % 10 <= 4) && !(draft.length % 100 >= 12 && draft.length % 100 <= 14) ? 'и' : ''}`;
        saveBtn.disabled = draft.length === 0;
        undoBtn.disabled = draft.length === 0;
        clearBtn.disabled = draft.length === 0;
      }

      // Клик по карте — только в черновик
      map.events.add('click', (e) => {
        const [lon, lat] = e.get('coords'); // [lat, lon] от Яндекс.Карт
        const t = titleInput.value.trim();
        draft.push({ latitude: lat, longitude: lon});
        titleInput.value = '';

        const pm = new ymaps.Placemark([lon, lat], { balloonContent: `<b>${t || ''}</b> (черновик)` });
        pm.__draft__ = true;
        draftCollection.add(pm);

        updateDraftUI();
      });

      // Кнопка "Сохранить N точек" — один POST
      saveBtn.addEventListener('click', async () => {
        if (!draft.length) return;
        try {
          statusEl && (statusEl.textContent = 'Сохраняю батч...');
          saveBtn.disabled = true;
          undoBtn.disabled = true;
          clearBtn.disabled = true;

          // Отправляем все точки одним запросом
          const data = await addPointsBulk(draft);
          const viewUrl = `${window.location.origin}/api/map/${data.slug}`;
          const linkBox = document.getElementById('shareLink');
          linkBox.innerHTML = `Ссылка на подборку: <a href="${viewUrl}" target="_blank" rel="noopener">${viewUrl}</a>`;

          draft = [];
          draftCollection.removeAll();
          updateDraftUI();
          statusEl && (statusEl.textContent = 'Сохранено');
        } catch (err) {
          console.error(err);
          if (statusEl) {
            statusEl.textContent = 'Ошибка: ' + err.message;
            statusEl.classList.add('error');
            setTimeout(() => statusEl.classList.remove('error'), 3000);
          }
          updateDraftUI();
        }
      });

      // Отменить последнюю точку из черновика (и с карты)
      undoBtn.addEventListener('click', () => {
        if (!draft.length) return;
        draft.pop();
        // убрать последний черновой placemark
        const last = draftCollection.get( draftCollection.getLength() - 1 );
        if (last) draftCollection.remove(last);
        updateDraftUI();
      });

      clearBtn.addEventListener('click', () => {
        draft = [];
        draftCollection.removeAll();
        updateDraftUI();
      });

      document.getElementById('openView').addEventListener('click', () => {
        window.open(`/api/map/`, '_blank');
      });

      updateDraftUI();
    });
  </script>
</body>
</html>
